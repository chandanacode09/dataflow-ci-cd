# Cloud Build CI Pipeline for Dataflow Monorepo
# This pipeline runs on pull requests and code pushes
# It performs code quality checks, linting, and testing for all pipelines

steps:
  # ==================== Shakespeare WordCount Pipeline ====================
  # Step 1a: Install dependencies for Shakespeare pipeline
  - name: 'python:3.9'
    id: 'install-deps-shakespeare'
    dir: 'pipelines/shakespeare-wordcount'
    entrypoint: 'pip'
    args: ['install', '-r', 'requirements.txt']

  # Step 2a: Run code formatting check with Black for Shakespeare pipeline
  - name: 'python:3.9'
    id: 'check-formatting-shakespeare'
    dir: 'pipelines/shakespeare-wordcount'
    entrypoint: 'python'
    args: ['-m', 'black', '--check', '.']
    waitFor: ['install-deps-shakespeare']

  # Step 3a: Run linting with flake8 for Shakespeare pipeline
  - name: 'python:3.9'
    id: 'lint-shakespeare'
    dir: 'pipelines/shakespeare-wordcount'
    entrypoint: 'python'
    args: ['-m', 'flake8', 'main.py', '--max-line-length=100']
    waitFor: ['install-deps-shakespeare']

  # Step 4a: Run unit tests for Shakespeare pipeline
  - name: 'python:3.9'
    id: 'test-shakespeare'
    dir: 'pipelines/shakespeare-wordcount'
    entrypoint: 'python'
    args: ['-m', 'pytest', 'tests/', '-v', '--cov=.', '--cov-report=term-missing']
    waitFor: ['install-deps-shakespeare']

  # Step 5a: Validate Shakespeare pipeline syntax
  - name: 'python:3.9'
    id: 'validate-shakespeare'
    dir: 'pipelines/shakespeare-wordcount'
    entrypoint: 'python'
    args: ['main.py', '--help']
    waitFor: ['install-deps-shakespeare', 'lint-shakespeare', 'test-shakespeare']

  # ==================== USA Names Stats Pipeline ====================
  # Step 1b: Install dependencies for USA Names pipeline
  - name: 'python:3.9'
    id: 'install-deps-usa-names'
    dir: 'pipelines/usa-names-stats'
    entrypoint: 'pip'
    args: ['install', '-r', 'requirements.txt']

  # Step 2b: Run code formatting check with Black for USA Names pipeline
  - name: 'python:3.9'
    id: 'check-formatting-usa-names'
    dir: 'pipelines/usa-names-stats'
    entrypoint: 'python'
    args: ['-m', 'black', '--check', '.']
    waitFor: ['install-deps-usa-names']

  # Step 3b: Run linting with flake8 for USA Names pipeline
  - name: 'python:3.9'
    id: 'lint-usa-names'
    dir: 'pipelines/usa-names-stats'
    entrypoint: 'python'
    args: ['-m', 'flake8', 'main.py', '--max-line-length=100']
    waitFor: ['install-deps-usa-names']

  # Step 4b: Run unit tests for USA Names pipeline
  - name: 'python:3.9'
    id: 'test-usa-names'
    dir: 'pipelines/usa-names-stats'
    entrypoint: 'python'
    args: ['-m', 'pytest', 'tests/', '-v', '--cov=.', '--cov-report=term-missing']
    waitFor: ['install-deps-usa-names']

  # Step 5b: Validate USA Names pipeline syntax
  - name: 'python:3.9'
    id: 'validate-usa-names'
    dir: 'pipelines/usa-names-stats'
    entrypoint: 'python'
    args: ['main.py', '--help']
    waitFor: ['install-deps-usa-names', 'lint-usa-names', 'test-usa-names']

# Cloud Build options
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'N1_HIGHCPU_8'

# Timeout for the entire build
timeout: '1200s'
